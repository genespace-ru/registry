resources:
  type: table
  displayName: Resources
  order: 10
  doc: Resources. Currently - tools, workflows, notebooks.
  primaryKey: ID
  
  scheme:
    columns:
    - ID:
        type: KEYTYPE
        autoIncrement: true
        primaryKey: true
    - repository:
        type: KEYTYPE
        reference: repositories.ID
        doc: repository
    - name:
        type: VARCHAR(256)
        doc: |
          Resource name. It may only consist of alphanumerics and internal underscores and hyphens, 
          but no spaces or other characters. Names may not exceed 256 characters.
    - type:
        type: ENUM(tool, workflow, notebook)
        doc: resource type
    - language:
        type: ENUM(CWL, WDL, NFL)
        doc: resource language
    - topic:
        type: VARCHAR(150)
        canBeNull: true
        doc: |
          An optional short text description of the resource.
    - info:
        type: JSONB 
        canBeNull: true
        doc: Other structured information from dockstore.yml
                            
    - whoInserted___:
        type: VARCHAR(100)
        defaultValue: '''Administrator'''
    - creationDate___:
        type: DATETIME
        defaultValue: CURRENT_TIMESTAMP
    - whoModified___:
        type: VARCHAR(100)
        canBeNull: true
    - modificationDate___:
        type: DATETIME
        canBeNull: true
        
  queries:
  - '*** Selection view ***':
      code: |-
        SELECT
          rs.ID,
          CONCAT(rp.url, '/', rs.name, '(', rs.type, ')')
        FROM resources rs
        JOIN repositories rp ON rp.ID = rs.repository
        ORDER BY 2
           
  - All records:
      roles: '@AllRoles'
      layout: '{"quickType":"select"}'
      code: |-
        SELECT
          rs.ID AS "___ID",
          rs.ID AS "___resID",
          CONCAT('<a href="https://github.com/', rp.url, '" target="_blank">', rp.url, '</a>') AS "Repository",
          rs.name AS "Name",
          '<link table="resources" queryName="Resource card" using="___resID" columns="ID" />' AS ";Name",
          rs.type AS "Type;<quick visible='true' />",
          rs.language AS "Language;<quick visible='true' />",
          rs.topic AS "Description;<quick visible='true' />",
          rs.info AS "Info;<quick visible='false' />",
          <@COMMON_WHO_FIELDS 'rs' />
        FROM resources rs
        JOIN repositories rp ON rp.ID = rs.repository
        ORDER BY 1
        
  - Resource card:
      roles: '@AllRolesExceptGuest'
      type: 1D_unknown
      layout: '{"tableBox":"resourceCard", "mode":"named", "hideTitle":"true"}'
      invisible: true
      code: |-
            SELECT
              r.ID AS "ID",
              r2v.version AS "verver",
              CONCAT( 'Карточка ресурса: ', r.name, ':', ver.name ) AS "PageTitle"
            FROM resources r
            JOIN resource2versions r2v ON r2v.resource = r.ID
            JOIN versions ver ON r2v.version = ver.ID
            WHERE 1 = 1
            <if parameter="ID">
                AND r.ID = <parameter:ID/>
            </if>
            <if parameter="___verID">
              AND r2v.version = <parameter:___verID/>
            </if>
  - ResourceTab:
      roles: '@AllRolesExceptGuest'
      invisible: true
      type: 1D_unknown
      layout: '{"tableBox":"resourceTab", "mode":"named", "hideTitle":"true"}'
      code: |-
        SELECT r.ID AS "ID",
            'Workflow: ' || r.name AS "PageTitle",
             CONCAT(r.name, ':', ver.name) AS "Name",
             r.type AS "Type",
             r.language AS "Descriptor type",
             r2v.primaryDescriptorPath AS "filepath___",
             r.topic AS "topic___",
             rp.url AS "repository___",
             r2v.readMePath AS "readme___",
             ver.name AS "version___",
             TO_CHAR(r.creationDate___,     'DD.MM.YYYY, HH24:MI') AS "creationdate___",
             TO_CHAR(r.modificationDate___, 'DD.MM.YYYY, HH24:MI') AS "modificationdate___",
             r.whoInserted___,
             r.whoModified___
        FROM resources r
        JOIN repositories rp ON rp.ID = r.repository
        JOIN resource2versions r2v ON r2v.resource = r.ID
        JOIN versions ver ON r2v.version = ver.ID
          WHERE (1=1)
          <if parameter="___resID">
              AND r.ID = <parameter:___resID/>
          </if>
          <if parameter="___verID">
              AND r2v.version = <parameter:___verID/>
          </if>
     
